<!doctype html>
<html lang="pt-br">
<head>
	<meta charset="utf-8">

	<title>Oficina do Charlão</title>
	<meta name="description" content="So it begins">
	<meta name="author" content="Carlos Lemos vulgo @carlos_tlemos no Twitter">

	<link href='https://fonts.googleapis.com/css?family=Slabo+27px' rel='stylesheet' type='text/css'>
	<link href='styles/style.css' rel='stylesheet' type='text/css'>
	<script src="scripts/jquery.js"></script>
</head>

<body>
	<h1>Bem vindo a oficina do Charlão</h1>

	<form>
		<input type="text" placeholder="insira seu nome" data-input="nome"></input>
		<div class="botao" data-botao="nome">Enviar</div>
	</form>

	<form>
		<input type="password" placeholder="insira sua senha" data-input="senha"></input>
		<div class="botao" data-botao="senha">Enviar</div>
	</form>
	

	<script>
		window.oficina= window.oficina || {};
		(function($){
			oficina.abertura = function(hash){
				var dados = {}, 

				load = function(url) {
					// cria ações no placeholder dos inputs
					$('input').each(function(){
						$(this)
							.attr('onfocus','this.placeholder = ""')
							.attr('onblur','this.placeholder = "'+this.placeholder+'"');
					});

					$('[data-botao="nome"]').click(enviaNome);
					$('[data-botao="senha"]').click(enviaSenha);

					$.ajax({
						type: 'POST',
						url: '/entrar',
						data: JSON.stringify(dados),
						dataType:'json',
						success: function(data){
							dados = data
							carrega();
						}
					});
				},

				// Ação ao enviar o nome
				enviaNome = function(event){
					event.preventDefault();
					dados.nome = $('[data-nome-input]').val();

					$.ajax({
						type: 'POST',
						url: '/usuario',
						data: JSON.stringify(dados),
						dataType:'json',
						success: function(data){
							dados.nome = data
							$('[data-nome]').parent().hide();
							$('[data-senha]').parent().fadeIn();
						}
					});
				},

				// Ação ao buscar a senha
				enviaSenha = function(event){
					event.preventDefault();
					dados.senha = $('[data-senha-input]').val()
					$.ajax({
						type: 'POST',
						url: '/senha',
						data: JSON.stringify(dados),
						dataType:'json',
						success: function(data){
							if(data.loggado)
								$('[data-senha]').parent().hide();
							else
								$('[data-senha-input]').attr('placeholder','senha incorreta').val('')
						}
					});
				},

				carrega = function(){
					if(!dados.loggado && !dados.nome)
						$('[data-nome]').parent().fadeIn();
					else if(!dados.loggado)
						$('[data-senha]').parent().fadeIn();
				};

				return { // todos os objetos aqui são públicos
					// implementação do método de inicialização público
					init: function(){
						load();
					}
				};
			};


			// Acão de pedir a senha ao servidor
			oficina.minhaSenha = function(){
				$.ajax({
					type: 'POST',
					url: '/mpw',
					data: JSON.stringify(true),
					dataType:'json',
					success: function(data){
						console.log('Anote sua senha: '+data.senha);
					}
				});
				return true;
			};

			//Let the carnage begins!
			(new oficina.abertura()).init();
		}(jQuery));
	</script>
</body>
</html>